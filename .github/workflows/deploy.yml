name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      CONTAINER_NAME: muuyal.tech
      ECR_REPOSITORY: muuyal.tech

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image URI
        run: echo "IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}" >> "$GITHUB_ENV"

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_URI }}:latest
            ${{ env.IMAGE_URI }}:${{ github.sha }}

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -e
            IMAGE="${{ env.IMAGE_URI }}:latest"
            CONTAINER="${{ env.CONTAINER_NAME }}"
            APP_DIR="${HOME}/apps/muuyal.tech"
            ENV_FILE="${APP_DIR}/.env"
            HOST_PORT="${{ secrets.APP_HOST_PORT }}"
            CONTAINER_PORT="${{ secrets.APP_CONTAINER_PORT }}"
            DOCKER_NETWORK="${{ secrets.DOCKER_NETWORK }}"
            AWS_REGION="${{ secrets.AWS_REGION }}"
            AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
            AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
            AWS_SESSION_TOKEN="${{ secrets.AWS_SESSION_TOKEN }}"

            if [ -z "$HOST_PORT" ]; then HOST_PORT="80"; fi
            if [ -z "$CONTAINER_PORT" ]; then CONTAINER_PORT="5000"; fi
            if [ -z "$DOCKER_NETWORK" ]; then DOCKER_NETWORK="shared_network"; fi

            mkdir -p "$APP_DIR"
            if [ ! -f "$ENV_FILE" ]; then
              echo "Missing env file: $ENV_FILE"
              exit 1
            fi

            export AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_REGION
            if [ -n "$AWS_SESSION_TOKEN" ]; then export AWS_SESSION_TOKEN; fi

            aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "${{ steps.login-ecr.outputs.registry }}"
            docker pull "$IMAGE"

            docker stop "$CONTAINER" || true
            docker rm "$CONTAINER" || true

            docker run -d \
              --name "$CONTAINER" \
              --restart unless-stopped \
              --network "$DOCKER_NETWORK" \
              -p "${HOST_PORT}:${CONTAINER_PORT}" \
              --env-file "$ENV_FILE" \
              "$IMAGE"

            docker image prune -f
